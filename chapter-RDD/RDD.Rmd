---
title: "ScPoEconometrics"
subtitle: "Regression Discontinuity Design"
author: "Florian Oswald, Gustave Kenedi and Pierre Villedieu"
date: "SciencesPo Paris </br> `r Sys.Date()`"
output:
  xaringan::moon_reader:
    chakra: "https://cdnjs.cloudflare.com/ajax/libs/remark/0.14.0/remark.min.js"
    lib_dir: libs
    css: [default, "../css/scpo.css", "../css/scpo-fonts.css"]
    nature:
      beforeInit: ["../js/ru_xaringan.js"]
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
      ratio: "16:9"
    includes:
      in_header: "../libs/partials/header.html"
---

layout: true

<div class="my-footer"><img src="../img/logo/ScPo-shield.png" style="height: 60px;"/></div> 

---

```{r setup, include=FALSE,warning=FALSE,message=FALSE}
options(htmltools.dir.version = FALSE)
knitr::opts_chunk$set(
  message = FALSE,
  warning = FALSE,
  dev = "svg",
  cache = TRUE,
  fig.align = "center"
  #fig.width = 11,
  #fig.height = 5
)

# define vars
om = par("mar")
lowtop = c(om[1],om[2],0.1,om[4])

overwrite = FALSE

library(tidyverse)
library(ggplot2)
library(grid)
library(pBrackets) 
library(emo)
library(viridis)

  # set seed
set.seed(1234)

```

layout: true

<div class="my-footer"><img src="../img/logo/ScPo-shield.png" style="height: 60px;"/></div> 

---

# Recap from last week

* Apply inference tools to regression analysis

* *Standard error* of regression coefficient

* *Statistical significance* of regression coefficient

--

## Today: Program Evaluation 

2 popular methods of causal policy evaluation:

.pull-left[
***Regression Discontinuity Design***

  * Exploits knowledge of assignment rule
  
  * Assignment to treatment is as good as random
]

--

.pull-left[
***Differences-in-differences***

  * Exploits changes in policy over time
  
  * Find the appropriate control group
]
---

# Regression Discontinuity Design (RDD)

* Very common research design in applied research because it provides credible causal estimates.

--

* Starting point: subjects are ***not*** randomly allocated to treatment `r emo::ji("warning")`

--

* RDD can be applied when we have specific information about the rules determining treatment.

--

* __RDD__ exploits this precise information about allocation to treatment!

---

# Discontinuities are Everywhere

There are many arbitrary rules in life that determine assignment to some treatment:
  
--
  
* In North Carolina, you used to have to have reached the age of five by October 16 in the relevant year to be eligible to enter kindergarten [(Cook and Kang, 2016)](https://pubs.aeaweb.org/doi/pdfplus/10.1257/app.20140323);
  
--
  
* In the US, a new born baby weighing less than 1,500 grams is considered to be of "very low birth weight" [(Almond et al., 2010)](https://academic.oup.com/qje/article/125/2/591/1882183).
  
--

* Examples from US public assistance etc. => find RDD papers

--

* merit-based scholarships

--

* Legal age for lacohol consumption in the US: 21 years old

---

# An Example: Alcohol Consumption and Mortality

--

* Imagine you are interested in assessing the __causal__ impact of alcohol consumption by young adults on mortality.

--

* Why is this not that straightforward? Why can't you just regress alcohol consumption on dying age and cause of death?

--

  * Because there may be unobserved selection into alcohol consumption that is also a determinant of mortality.
  
--

* Recent [paper](http://masteringmetrics.com/wp-content/uploads/2015/01/Carpenter-and-Dobkin-2009.pdf) by Christopher Carpenter and Carlos Dobkin entitled "The Effect of Alcohol Consumption on Mortality: Regression Discontinuity Evidence from the Minimum Drinking Age"

--

* Estimates the effect of young adults' alcohol consumption on mortality in the United States.

---

# Institutional Details

* In the US, alcohol consumption is prohibited before the age of 21.

* Debate on whether the minimum legal drinking age (MLDA) should be lowered to 18, as was the case in the Vietnam-era.


--

## Discontinuity Feature

> ***Running variable:*** variable that determines assignment to treatment.

--

$\rightarrow$ $a$ = age

--

> ***Cutoff level:*** level of the ***running variable*** above (or below) which individuals are treatedd (or not).

--

$\rightarrow$ $c = 21$ year old birthday

--

* How different are individuals *just before* and *just after* their 21st birthday, other than legal access to alcohol?

--

* `r emo::ji("point_right")` ***Regression discontinuity design*** exploits this allocation to treatment!

---

# Carpenter and Dobkin's data: `masteringmetrics` package

* Let's take a closer at their data
```{r, echo = TRUE, eval = TRUE}
# install package containing data
devtools::install_github("jrnold/masteringmetrics",
                         subdir = "masteringmetrics")

library(masteringmetrics) # load package
data("mlda", package = "masteringmetrics") # load data
```

* This dataset contains aggregate death rates (and their causes) for different age groups (`agecell`) between 19 and 23 years old.

* Let's first reshape this dataset to make it more easily exploitable:
```{r, echo = TRUE, eval = TRUE}
mlda_long <- mlda %>%
  select(-contains("fitted")) %>%        # drop "fitted" variables
  pivot_longer(cols = -agecell,          # column to not reshape
               names_to = "death_cause", # new variable containing death causes
               values_to = "death_rate") # new variable containing death rates by cause
```

---

# Sharp Discontinuity at Cutoff

```{r, echo = FALSE, eval = TRUE, fig.height = 4.75, fig.width = 10}
mlda <- mlda %>%
  mutate(over21 = (agecell >= 21))

rdd_run <- mlda %>%
  ggplot(aes(x = agecell, y = over21, color = over21)) +
  geom_point(size = 4, alpha = 0.8) +
  geom_vline(xintercept = 21, linetype = "longdash") +
  labs(x = "Age", y = "Above LMDA") +
  scale_color_viridis_d() +
  theme_bw(base_size = 14) + theme(legend.position="none")
rdd_run
```

At the threshold, the probability of being treated jumps from 0 to 1.

---

# Causal Intuition

Individuals just above the cutoff are treatment and those just below are control group

assignment to treatment is as good as random

now we compare the outcomes for those who just are just above and those just below

---

# Sharp Discontinuity at Cutoff

```{r, echo = FALSE, eval = TRUE, fig.height = 4.75, fig.width = 10}
rdd_run +
  annotate("rect", xmin = 20.5, xmax = 21.5, ymin = 0, ymax = Inf, alpha = .2) +
  annotate("rect", xmin = 21 - 1/12, xmax = 21 + 1/12, ymin = 0, ymax = Inf, alpha = .4) +
  geom_point(size = 4, alpha = 0.8) +
  geom_vline(xintercept = 21, linetype = "longdash")
```

---

# Sharp Discontinuity at Cutoff

```{r, echo = FALSE, eval = TRUE, fig.height = 4.75, fig.width = 10}
rdd_run +
  annotate("rect", xmin = 20.5, xmax = 21.5, ymin = 0, ymax = Inf, alpha = .2) +
  annotate("rect", xmin = 21 - 1/12, xmax = 21 + 1/12, ymin = 0, ymax = Inf, alpha = .4) +
  geom_point(size = 4, alpha = 0.8) +
  geom_vline(xintercept = 21, linetype = "longdash") +
  scale_x_continuous(breaks = c(21 - 6/12, 21 - 3/12, 21, 21 + 3/12, 21 + 6/12),
                     labels = c("- 6 months", "- 3 months", "21", "+ 3 months", "+ 6 months"),
                     minor_breaks = seq(from = 21 - 7/12, to = 21 + 7/12, by = 1/12),
                     lim = c(21 - 7/12, 21 + 7/12))
```

---

class: inverse

# Task 1 (10 minutes)

1. Take a look at the dataset and list the variables.

1. How many age cells are there?

1. Plot the death rate for all causes (`all`) as a function of age (`agecell`). Does anything seem striking?

1. Create a `facet_grid` ggplot with death rates for all causes (`all`), motor vehicle-related causes (`mva`) and alcohol-related causes (`alcohol`) as a function of age.  
(*Hint:* you need to filter the death causes first and then create the plot. Use the `scales = "free_y"` option in `facet_grid()`)

1. Create a dummy variable for individuals over 21 years old.

1. Compute the average death rate (`all`), the average motor vehicle-related death rate (`mva`) and the average alcohol-related death rate (`alcohol`) for individuals under and over 21 years old. What does this simple comparison suggest?

1. Make the same comparisons but keeping only age cells striclty between 20 and 22. Does this restriction change anything?

---

# Graphical Results: All Death Rates

```{r, echo = FALSE, eval = TRUE, fig.height = 5, fig.width = 10}
rdd_plot <- mlda %>%
  ggplot(aes(x = agecell, y = all, color = over21)) +
  geom_point(size = 4) +
  geom_vline(xintercept = 21, linetype = "longdash") +
  labs(x = "Age",
       y = "Death rate from all causes (per 100,000)",
       color = NULL) +
  scale_colour_viridis_d(aesthetics = c("colour", "fill"), labels = c("FALSE" = "Control", "TRUE" = "Treatment")) +
  theme_bw(base_size = 14) +
  theme(legend.position="none")
rdd_plot
```

---

# Graphical Results: All Death Rates

```{r, echo = FALSE, eval = TRUE, fig.height = 5, fig.width = 10}
library(broom)
all_fit <- augment(lm(all ~ agecell + over21, mlda))

rdd_plot_line <- rdd_plot +
  geom_ribbon(data = all_fit %>% filter(agecell < 21), aes(ymin = .fitted - 1.96*.se.fit, ymax = .fitted + 1.96*.se.fit, fill = over21), alpha = 0.5, colour = NA) +
  geom_ribbon(data = all_fit %>% filter(agecell >= 21), aes(ymin = .fitted - 1.96*.se.fit, ymax = .fitted + 1.96*.se.fit, fill = over21), alpha = 0.5, colour = NA) +
  geom_line(data = all_fit %>% filter(agecell < 21), aes(x = agecell, y = .fitted), color = viridis_pal()(2)[1], size = 2) +
  geom_line(data = all_fit %>% filter(agecell >= 21), aes(x = agecell, y = .fitted), color = viridis_pal()(2)[2], size = 2) +
labs(fill = NULL)
rdd_plot_line
```

---

# Graphical Results: All Death Rates

```{r, echo = FALSE, eval = TRUE, fig.height = 5, fig.width = 10}
bracketsGrob <- function(...){
l <- list(...)
e <- new.env()
e$l <- l
  grid:::recordGrob(  {
    do.call(grid.brackets, l)
  }, e)
}

mlda_fitted <- augment(lm(all ~ agecell + over21, mlda))

b1 <- bracketsGrob(21, all_fit$.fitted[all_fit$agecell < 21 & all_fit$agecell > 20.9], 21, all_fit$.fitted[all_fit$agecell > 21 & all_fit$agecell <= 21.1],
                   h = 0.75, lwd=1.5, col="black")

rdd_plot_line_brack <- rdd_plot_line +
  annotation_custom(b1,xmin= 0, xmax=1, ymin=0, ymax=1) +
  annotate("text", x = 20.65, y = 96, label = "Treatment\nEffect", colour = "black", size = 5)
rdd_plot_line_brack
```

---

# Zoom into that graph

```{r, echo = FALSE, eval = TRUE, fig.height = 5, fig.width = 10}
bracketsGrob <- function(...){
l <- list(...)
e <- new.env()
e$l <- l
  grid:::recordGrob(  {
    do.call(grid.brackets, l)
  }, e)
}

mlda_fitted <- augment(lm(all ~ agecell + over21, mlda %>% filter(agecell >= 20.5 & agecell <= 21.5)))

b1 <- bracketsGrob(21, all_fit$.fitted[all_fit$agecell < 21 & all_fit$agecell > 20.9], 21, all_fit$.fitted[all_fit$agecell > 21 & all_fit$agecell <= 21.1],
                   h = 0.75, lwd=1.5, col="black")

rdd_plot_line +
  annotation_custom(b1,xmin= 0, xmax=1, ymin=0, ymax=1) +
  annotate("text", x = 20.9, y = 96, label = "Treatment\nEffect", colour = "black", size = 5) +
  scale_x_continuous(breaks = c(21 - 6/12, 21 - 1/12, 21, 21+1/12, 21 + 6/12),
                     labels = c("- 6 months", "- 1 month", "21", "+ 1 month", "+ 6 months"),
                     minor_breaks = seq(from = 21 - 7/12, to = 21 + 7/12, by = 1/12),
                     lim = c(21 - 7/12, 21 + 7/12))
```

---

# RDD Setup

* ***Treatment variable***: $D_a$

--

  - $D_a$ = 1 if individual is over 21 years old, $D_a$ = 0 if not.

--

  - $D_a$ is a function of the individual's age, $a$, which is the ***running variable***.
  
--

* The ***cutoff*** age, 21, separates those who can drink legally and those who can't:
  $$
  D_a = \begin{cases}\begin{array}{lcl}
  1 \quad \text{if } a \geq 21 \\\
  0 \quad \text{if } a < 21
  \end{array}\end{cases}
  $$
  
## Key features of RD designs

1. Treatment status is a __deterministic__ function of $a$ $\rightarrow$ we know the assignment rule

--

1. Treatment status is a __discontinuous__ function of $a$ $\rightarrow$ there is some cutoff level

---

# RDD Setup

* We observe only $Y_i^1$ for individuals above 21 and only $Y_i^0$ for those below.

* The treatment may be as good as randomly assigned for individuals in the neighborhood of the cutoff, so comparing treated and nontreated near cutoff reveals a treatment effect.

## Image potential and observed outcomes?

---

# RDD as Local Average Treatment Effect (LATE)

* The RD estimator is a __local average treatment effect__.

* Core intuition: around the threshold things could have gone either way.

* It only tells you the impact of treatment $D$ on outcome $Y$ ***around*** the cutoff value of the running variable.

* Limited external validity $\rightarrow$ you cannot extrapolate to the entire population.

* Using the 21 year old alcohol restriction age in the RD context will only tell you the effect of this restriction on death rates but not the general effect of alcohol consumption.

* One may easily argue that all results from quantitative empirical analyses have a local nature.

---

layout: false
class: title-slide-section-red, middle

# Estimation

---

layout: true

<div class="my-footer"><img src="../img/logo/ScPo-shield.png" style="height: 60px;"/></div> 

---

# Sharp RDD

* Writing in regression form, we have
    $$DEATHRATE_a = \alpha + \delta D_a + \beta a + \varepsilon_i,$$
  where $DEATHRATE_a$ is the death rate at age $a$ (defined in months relative to the 21st birthday), $D_a$ is the treatment dummy, and $a$ is age (again, defined relative the 21st birthday).

--

  $\rightarrow$ $\delta$ captures the **jump in death rate** between individuals above and below 21 years old.

--

* The RDD estimator exploits a discontinuity at $a = 21$ in the conditional expectation function:
    $$\delta = \lim_{a \to 21^+} E[DEATHRATE_a^1|a = 21] - \lim_{a \to 21^-} E[DEATHRATE_a^0|a = 21]$$
    where $\lim_{a\to 21^+}$ means $a$ *approaches* $21$ *from above*.
    
---

class: inverse

# Task 2 (5 minutes)

* Estimate the following model on all death causes. Does the RDD coefficient correspond to the graphical illustration? 
$$DEATHRATE_a = \alpha + \delta D_a + \beta a + \varepsilon_i,$$

--

```{r, echo = TRUE, eval = TRUE}
mlda <- mlda %>%
  mutate(over21 = factor(agecell >= 21))
rd <- lm(all ~ agecell + over21, mlda)
```
```{r, echo = FALSE, eval = TRUE}
knitr::kable(coef(summary(rd)), format = 'html', digits = 2)
```

--

* Interpretation?

---

# Estimation

* Functional form

* Nonparametric estimation

* Bandwidth selection

* Standard errors

---

# Simulations - Linear Relationship and Clear Discontinuity

```{r, echo = FALSE, fig.height = 4.5}
set.seed(1234)

# packages
library(viridis)
library(dplyr)
library(ggplot2)

  # parameters
cutoff = 0.5
alpha = 0.2 # intercept
delta = 0.4 # jump at cutoff
beta = 2 # slope
nsim = 150 # number of simulated observations

  # running variable
x = runif(n = nsim,
          min = 0,
          max = 1)

  # treatment variable
D = if_else(x > cutoff, TRUE, FALSE)

  # error term
u = rnorm(n = nsim, mean = 0, sd = .1)

  # outcome variable
Y = alpha + beta * x + D*delta + u

  # create tibble
rdd_sim = tibble(running = x,
                 treatment_dum = D,
                 outcome = Y)
  
  # plot
rdd_lin <- ggplot(rdd_sim,
       aes(x = running, y = outcome, color = treatment_dum)) +
  geom_point() +
  stat_smooth(method = "lm", se = FALSE) +
  ylim(0,3) +
  labs(x = "Running variable", y = "Outcome variable") +
  scale_colour_viridis_d(name = "Experimental Condition",
                        breaks=c("FALSE", "TRUE"), labels = c("Control", "Treatment")) +
  theme_bw(base_size = 16) + theme(legend.position="top")
rdd_lin
```

--

$$outcome_i = \alpha + \delta treatment_i + \beta running_i + error_i,$$

---

# Simulations - Linear Relationship and Clear Discontinuity

```{r, echo = FALSE, fig.height = 4.5}
bracketsGrob <- function(...){
l <- list(...)
e <- new.env()
e$l <- l
  grid:::recordGrob(  {
    do.call(grid.brackets, l)
  }, e)
}

b1 <- bracketsGrob(0.505, 1.20, 0.505, 1.63, h = 0.2, lwd=1.5, col="black")

rdd_lin +
  annotation_custom(b1,xmin= 0, xmax=1, ymin=0, ymax=1) +
  annotate("text", x = 0.45, y = 1.45, label = "delta", colour = "#d90502", parse = T, size = 8)
```

$$outcome_i = \alpha + \color{#d90502}\delta treatment_i + \beta running_i + error_i,$$

---

# Simulations - Quadratic Relationship and Clear Discontinuity

```{r, echo = FALSE, fig.height = 4.5}
set.seed(1234)

  # packages
library(viridis)
library(dplyr)
library(ggplot2)

  # parameters
cutoff = 0.5
alpha = 1.5 # intercept
delta = 0.4 # jump at cutoff
beta = -8 # slope
beta_2 = 25
beta_3 = -17
nsim = 150 # number of simulated observations

  # running variable
x = runif(n = nsim,
          min = 0,
          max = 1)

  # treatment variable
D = if_else(x > cutoff, TRUE, FALSE)

  # error term
u = rnorm(n = nsim, mean = 0, sd = .1)

  # outcome variable
Y = alpha + beta * x + beta_2 * x^2 + beta_3 * x^3 + D*delta + u

  # create tibble
rdd_sim = tibble(running = x,
                 treatment_dum = D,
                 outcome = Y)

  # plot
rdd_quad <- ggplot(rdd_sim,
       aes(x = running, y = outcome, color = treatment_dum)) +
  geom_point() +
  stat_smooth(method = "lm",
              formula = y ~ poly(x, 3),
              se = FALSE) +
  geom_vline(xintercept = 0.5, linetype = "longdash") +
  ylim(0,3) +
  labs(x = "Running variable", y = "Outcome variable") +
  scale_colour_viridis_d(name = "Experimental Condition",
                        breaks=c("FALSE", "TRUE"), labels = c("Control", "Treatment")) +
  theme_bw(base_size = 16) + theme(legend.position="top")
rdd_quad
```

--

$$outcome_i = \alpha + \delta treatment_i + \beta_1 running_i + \color{#d90502}{\beta_2 running_i^2} + error_i,$$

---

# Simulations - Quadratic Relationship and Clear Discontinuity

```{r, echo = FALSE, fig.height = 4.5}
bracketsGrob <- function(...){
l <- list(...)
e <- new.env()
e$l <- l
  grid:::recordGrob(  {
    do.call(grid.brackets, l)
  }, e)
}

b1 <- bracketsGrob(0.505, 1.68, 0.505, 2.05, h = 0.2, lwd=1.5, col="black")

rdd_quad +
  annotation_custom(b1,xmin= 0, xmax=1, ymin=0, ymax=1) +
  annotate("text", x = 0.45, y = 1.865, label = "delta", colour = "#d90502", parse = T, size = 8)
```

$$outcome_i = \alpha + \color{#d90502}\delta treatment_i + \beta_1 running_i + \beta_2 running_i^2 + error_i,$$

---

# Simulations - Linear Relationship but NO Discontinuity

```{r, echo = FALSE, fig.height = 4.5}
set.seed(123)

  # packages
library(viridis)
library(dplyr)
library(ggplot2)

  # parameters
cutoff = 0.5
alpha = 2.5 # intercept
beta_1 = 2.5 # slope
beta_2 = 0.5 # slope 2
power = 7
nsim = 150 # number of simulated observations

  # running variable
x = runif(n = nsim,
          min = 0,
          max = 1)

  # treatment variable
D = if_else(x > cutoff, TRUE, FALSE)

  # error term
u = rnorm(n = nsim, mean = 0, sd = .1)

  # outcome variable
Y = alpha + (1 - alpha) / (1 + (x/beta_2)^power) + u

  # without error term
Y_true = alpha + (1 - alpha) / (1 + (x/beta_2)^power)

  # create tibble
rdd_sim = tibble(running = x,
                 treatment_dum = D,
                 outcome = Y,
                 true = Y_true)

  # plot
rdd_nodisc <- ggplot(rdd_sim,
       aes(x = running, y = outcome, color = treatment_dum)) +
  geom_point() + geom_line(aes(x = running, y = true), colour = "black", linetype = "dotted") +
  stat_smooth(method = "lm",
              formula = y ~ x,
              se = FALSE) +
  geom_vline(xintercept = 0.5, linetype = "longdash") +
  ylim(0,3) +
  labs(x = "Running variable", y = "Outcome variable") +
  scale_colour_viridis_d(name = "Experimental Condition",
                        breaks=c("FALSE", "TRUE"), labels = c("Control", "Treatment")) +
  theme_bw(base_size = 16) + theme(legend.position="top")
rdd_nodisc
```

---

# Simulations - Different Slopes

```{r, echo = FALSE, fig.height = 4.5}
set.seed(1234)

  # packages
library(viridis)
library(dplyr)
library(ggplot2)

  # parameters
cutoff = 0.5
alpha = 1 # intercept
delta = 0.4 # jump at cutoff
beta = -1 # slope
gamma = 4
nsim = 150 # number of simulated observations

  # running variable
x = runif(n = nsim,
          min = 0,
          max = 1)

  # treatment variable
D = if_else(x > cutoff, TRUE, FALSE)

  # error term
u = rnorm(n = nsim, mean = 0, sd = .1)

  # outcome variable
Y = alpha + beta * (x - cutoff) + D*delta + gamma * D * (x - cutoff) + u

  # create tibble
rdd_sim = tibble(running = x,
                 treatment_dum = D,
                 outcome = Y)

  # plot
rdd_diffslope <- ggplot(rdd_sim,
       aes(x = running, y = outcome, color = treatment_dum)) +
  geom_point() +
  stat_smooth(method = "lm",
              formula = y ~ x,
              se = FALSE) +
  geom_vline(xintercept = 0.5, linetype = "longdash") +
  ylim(0,3) +
  labs(x = "Running variable", y = "Outcome variable") +
  scale_colour_viridis_d(name = "Experimental Condition",
                        breaks=c("FALSE", "TRUE"), labels = c("Control", "Treatment")) +
  theme_bw(base_size = 16) + theme(legend.position="top")
rdd_diffslope
```

--

$$outcome_i = \alpha + \delta treatment_i + \beta (running_i - cutoff) + \\ \color{#d90502}{\gamma treatment_i * (running_i - cutoff)} + error_i,$$

---

# Simulations - Different (Linear) Slopes

```{r, echo = FALSE, fig.height = 4.5}
bracketsGrob <- function(...){
l <- list(...)
e <- new.env()
e$l <- l
  grid:::recordGrob(  {
    do.call(grid.brackets, l)
  }, e)
}

b1 <- bracketsGrob(0.505, 0.99, 0.505, 1.46, h = 0.2, lwd=1.5, col="black")

rdd_diffslope +
  annotation_custom(b1,xmin= 0, xmax=1, ymin=0, ymax=1) +
  annotate("text", x = 0.45, y = 1.225, label = "delta", colour = "#d90502", parse = T, size = 8)
```

$$outcome_i = \alpha + \color{#d90502}\delta treatment_i + \beta (running_i - cutoff) + \\ \gamma treatment_i * (running_i - cutoff) + error_i,$$

---

# How to Choose Appropriate Functional Form?

* Essential to __visualise__ the data!

--

* Coefficients across models shouldn't vary too much

--

* [Gelman and Imbens (2019)](https://www.tandfonline.com/doi/abs/10.1080/07350015.2017.1366909), "Why High-Order Polynomials Should Not Be Used in Regression Discontinuity Designs":  
  *"We recommend researchers [...] use estimators based on local linear or quadratic polynomials or other smooth functions."*

--

* Should we expect the relationship between the outcome variable and the running variable to be nonlinear? Should we expect it to differ around the cutoff?

---

# Going Back to our Example: Nonlinearities / $\neq$ Slopes?

```{r, echo = FALSE, eval = TRUE, fig.height = 4.5}
rdd_plot
```

---

class: inverse

# Task 3 (15 minutes)

* Estimate the following *quadratic* model on all death causes. Does the RDD coefficient differ from the linear model? 
$$DEATHRATE_a = \alpha + \delta D_a + \beta a + \beta a^2 + \varepsilon_a,$$

* Recall that the regression model allowing for different slopes on each side of the cutoff is:
$$DEATHRATE_a = \alpha + \delta D_a + \beta (a - 21) + \\ \gamma D_a * (a - 21) + \varepsilon_a,$$
   - Why do we need to substract the `cutoff` from `running_i`? (Hint: compute $\mathbb{E}(outcome_i|running_i=cutoff)$)
   - Should we expect the relationship between death rates and age to change at 21?
   - Estimate this model. How different is the RDD coefficient from the other models you have estimated?

* Re-run these models (linear, quadratic, different slopes) for the following death causes: motor vehicle accidents (`mva`), alcohol-related (`alcohol`), and internal (`internal`).

---

# Graphical Representation of the Regression Results

```{r, echo = FALSE, eval = TRUE, fig.height = 5, fig.width = 10}
mlda_long <- mlda_long %>%
  mutate(over21 = as.factor(agecell >= 21)) %>%
  filter(death_cause %in% c("all","mva","internal"))
rdd_plot <- mlda_long %>%
  ggplot(aes(x = agecell, y = death_rate, color = over21)) + geom_point() +
    geom_smooth(mapping = aes(group = over21), se = FALSE, method = "lm",
              formula = y ~ x) +
  geom_vline(xintercept = 21, linetype = "longdash") +
  labs(x = "Age", y = "Death rate (per 100,000)") +
  scale_colour_viridis_d(name = "Experimental Condition",
                        breaks=c("FALSE", "TRUE"), labels = c("Control", "Treatment")) +
  theme_bw(base_size = 16) + theme(legend.position="top") +
  facet_grid(rows = vars(death_cause), scales = "free_y")
rdd_plot
```

---

layout: false
class: title-slide-section-red, middle

# Identifying Assumptions

---

layout: true

<div class="my-footer"><img src="../img/logo/ScPo-shield.png" style="height: 60px;"/></div> 

---

# RDD Assumptions

> *Key assumption*: ***Potential outcomes are smooth at the threshold.***

--

$\rightarrow$ assignment variable cannot be manipulated!

--

Formally:

$$\lim_{a \to 21^+} E[Y_i^d|a = 21] = \lim_{a \to 21^-} E[Y_i^d|a = 21], d \in \{0,1\}$$

* The population just below must not be discretely different from the population just above.

* Assumption is violated if people can manipulate the running variable because they know the cutoff value

  * Knowing the cutoff value in itself does not violate the assumption, only ability to manipulate running variable does

---

# RDD Assumptions

> *Key assumption*: ***Potential outcomes are smooth at the threshold.***

If the assumption holds, we have:

$$
\begin{align}
&\lim_{c \to 21^+} \mathbb{E}[Y_i | a_i = c] - \lim_{a \to 21^-} \mathbb{E}[Y_i | a_i = c] \\
= &\lim_{c \to 21^+} \mathbb{E}[Y_i^1 | a_i = c] - \lim_{c \to 21^-} \mathbb{E}[Y_i^0 | a_i = c] \\
= &\mathbb{E}[Y_i^1 | a_i = 21] - \mathbb{E}[Y_i^0 | a_i = 21] \\
= &\mathbb{E}[Y_i^1 - Y_i^0 | a_i = 21] \\
\end{align}
$$

---

# RDD Assumptions

> *Key assumption*: ***Potential outcomes are smooth at the threshold.***

If the assumption holds, we have:

$$
\begin{align}
&\lim_{c \to 21^+} \mathbb{E}[Y_i | a_i = c] - \lim_{a \to 21^-} \mathbb{E}[Y_i | a_i = c] \\
= &\lim_{c \to 21^+} \mathbb{E}[Y_i^1 | a_i = c] - \lim_{c \to 21^-} \mathbb{E}[Y_i^0 | a_i = c] \\
= &\mathbb{E}[Y_i^1 | a_i = 21] - \mathbb{E}[Y_i^0 | a_i = 21] \\
= &\underbrace{\mathbb{E}[Y_i^1 - Y_i^0}_\text{ATE} | a_i = 21] \\
\end{align}
$$

---

# Example of Manipulation


---

# McCracy Density Test

---

# Noncompliance

What if the running variable does not *fully* determine assignment to treatment?

$\rightarrow$ ***Fuzzy RDD***

* Is addressed using *instrumental variables* (not covered in this course but if you do another metrics class you most likely will)

* For you, just know that problem of imperfect determination of allocation to treatment can still be solved

---

# 5 Steps for Conducting RDD in Practice<sup>1</sup>

.footnote[
<sup>1</sup> Taken from [Andrew Weiss' wonderful course on RDD](https://evalsp20.classes.andrewheiss.com/class/11-class/).
]

### Step #1: ***Is assignment to treatment rule-based?***

--

### Step #2: ***Is design sharp or fuzzy?***

--

### Step #3: ***Is there a discontinuity in running variable at cutoff?***

--

### Step #4: ***Is there a discontinuity in outcome variable at cutoff in running variable?***

--

### Step #5: ***How big is the gap?***

---

class: title-slide-final, middle
background-image: url(../img/logo/ScPo-econ.png)
background-size: 250px
background-position: 9% 19%

# See you next week!




|                                                                                                            |                                   |
| :--------------------------------------------------------------------------------------------------------- | :-------------------------------- |
| <a href="mailto:florian.oswald@sciencespo.fr">.ScPored[<i class="fa fa-paper-plane fa-fw"></i>]               | florian.oswald@sciencespo.fr       |
| <a href="https://github.com/ScPoEcon/ScPoEconometrics-Slides">.ScPored[<i class="fa fa-link fa-fw"></i>] | Slides |
| <a href="https://scpoecon.github.io/ScPoEconometrics">.ScPored[<i class="fa fa-link fa-fw"></i>] | Book |
| <a href="http://twitter.com/ScPoEcon">.ScPored[<i class="fa fa-twitter fa-fw"></i>]                          | @ScPoEcon                         |
| <a href="http://github.com/ScPoEcon">.ScPored[<i class="fa fa-github fa-fw"></i>]                          | @ScPoEcon                       |